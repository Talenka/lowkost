'use strict';var player={model:{objects:new THREE.Object3D,motion:"stand",state:"stand"},position:{x:0,y:0,z:0,direction:0},camera:{speed:500,distance:thirdPersonCameraDistance,x:0,y:0,z:0},physicalShape:false,modelHeight:1.2,modelRadius:0.3};var md2meshBody;var moveState={moving:false,front:false,Backwards:false,left:false,right:false,speed:0.1,angle:0};
var md2frames={stand:[0,39,9,{state:"stand",action:false}],run:[40,45,10,{state:"stand",action:false}],attack:[46,53,10,{state:"stand",action:true}],pain1:[54,57,7,{state:"stand",action:true}],pain2:[58,61,7,{state:"stand",action:true}],pain3:[62,65,7,{state:"stand",action:true}],jump:[66,71,7,{state:"stand",action:true}],flip:[72,83,7,{state:"stand",action:true}],salute:[84,94,7,{state:"stand",action:true}],taunt:[95,111,10,{state:"stand",action:true}],wave:[112,122,7,{state:"stand",action:true}],
point:[123,134,6,{state:"stand",action:true}],crstand:[135,153,10,{state:"crstand",action:false}],crwalk:[154,159,7,{state:"crstand",action:false}],crattack:[160,168,10,{state:"crstand",action:true}],crpain:[196,172,7,{state:"crstand",action:true}],crdeath:[173,177,5,{state:"freeze",action:true}],death1:[178,183,7,{state:"freeze",action:true}],death2:[184,189,7,{state:"freeze",action:true}],death3:[190,197,7,{state:"freeze",action:true}],boom:[198,198,5]};var direction=0;
function move(){if(player.model.motion!=="run"&&player.model.state==="stand")changeMotion("run");else if(player.model.motion!=="crwalk"&&player.model.state==="crstand")changeMotion("crwalk");var speed=moveState.speed;if(player.model.state==="crstand")speed*=0.5;else if(player.model.state==="freeze")speed=0;direction=moveState.angle;if(moveState.front)if(moveState.left)direction=45;else if(moveState.right)direction=315;else direction=0;else if(moveState.Backwards)if(moveState.left)direction=135;else if(moveState.right)direction=
225;else direction=180;else if(moveState.left)direction=90;else if(moveState.right)direction=270;else direction=0;direction+=player.camera.x/2;player.model.objects.rotation.y=direction*deg2rad;player.position.x-=Math.sin(direction*deg2rad)*speed;player.position.z-=Math.cos(direction*deg2rad)*speed}
function changeMotion(motion){player.model.motion=motion;player.model.state=md2frames[motion][3].state;var animMin=md2frames[motion][0];var animMax=md2frames[motion][1];var animFps=md2frames[motion][2];md2meshBody.time=0;md2meshBody.duration=1E3*((animMax-animMin)/animFps);md2meshBody.setFrameRange(animMin,animMax)}
function animate(){requestAnimationFrame(animate);player.model.objects.position={x:player.position.x,y:player.position.y,z:player.position.z};if(player.physicalShape){player.physicalShape.position.x=player.position.x;player.physicalShape.position.y=player.position.y+player.modelHeight/2;player.physicalShape.position.z=player.position.z}camera.position.x=player.position.x+player.camera.distance*Math.sin(player.camera.x*deg2rad/2);camera.position.z=player.position.z+player.camera.distance*Math.cos(player.camera.x*
deg2rad/2);camera.position.y=1+player.position.y+player.camera.distance*Math.sin(player.camera.y*deg2rad/2);camera.lookAt(new THREE.Vector3(player.position.x,player.position.y+1,player.position.z));var delta=clock.getDelta();if(md2meshBody){var isEndFleame=md2frames[player.model.motion][1]===md2meshBody.currentKeyframe;var isAction=md2frames[player.model.motion][3].action;if(!isAction||isAction&&!isEndFleame)md2meshBody.updateAnimation(1E3*delta);else if(/freeze/.test(md2frames[player.model.motion][3].state));
else changeMotion(player.model.state)}renderer.render(scene,camera);scene.simulate()}function playerCollision(collided,velocity,momentum){console.log(velocity)}
function loadSkyAndGround(){scene.fog=new THREE.FogExp2(10066431,0.01);var ambientLight=new THREE.AmbientLight(2105376);scene.add(ambientLight);var planeGeometry=new THREE.PlaneGeometry(1E3,1E3);var planeMaterial=Physijs.createMaterial(new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/grass.png"),color:16777215}),0.8,0.3);planeMaterial.map.repeat.set(300,300);planeMaterial.map.wrapS=planeMaterial.map.wrapT=THREE.RepeatWrapping;var plane=new Physijs.BoxMesh(planeGeometry,planeMaterial,
0);plane.castShadow=false;plane.receiveShadow=true;scene.add(plane);var sunlight=new THREE.DirectionalLight(16777210,1.5);sunlight.position.set(1,50,1).normalize();sunlight.castShadow=true;scene.add(sunlight)}
function loadPlayerMesh(){droidMaterial=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/1.png"),ambient:10066329,color:16777215,specular:16777215,shininess:25,morphTargets:true});loader=new THREE.JSONLoader;loader.load("js/droid.js",function(geometry){md2meshBody=new THREE.MorphAnimMesh(geometry,droidMaterial);md2meshBody.rotation.y=-Math.PI/2;md2meshBody.scale.set(0.02,0.02,0.02);md2meshBody.position.y=0.5;md2meshBody.castShadow=true;md2meshBody.receiveShadow=true;changeMotion("stand");
player.model.objects.add(md2meshBody)});player.physicalShape=new Physijs.BoxMesh(new THREE.CylinderGeometry(player.modelRadius,player.modelRadius,player.modelHeight,16,4,false),new THREE.MeshLambertMaterial({opacity:0.3,transparent:true}),1);player.physicalShape.position.y=player.modelHeight/2;player.physicalShape.addEventListener("collision",playerCollision);scene.add(player.model.objects);scene.add(player.physicalShape)}
function createCubes(){var meshArray=[];for(var i=0;i<50;i++){meshArray[i]=new Physijs.BoxMesh(new THREE.CubeGeometry(1+Math.random(),Math.random(),1),new THREE.MeshLambertMaterial({color:16777215*Math.random()}));meshArray[i].position.x=i%2*5-2.5;meshArray[i].position.y=10*Math.random();meshArray[i].position.z=-0.8*i;meshArray[i].rotation.x=Math.random();meshArray[i].rotation.y=Math.random();meshArray[i].rotation.z=Math.random();meshArray[i].castShadow=true;meshArray[i].receiveShadow=true;scene.add(meshArray[i])}}
;Physijs.scripts.worker="js/physijs_worker.js";Physijs.scripts.ammo="ammo.js";var clock;var width;var height;var scene;var renderer;var deg2rad=Math.PI/180;var camera;var timer;var loader;var droidMaterial;var getElementPosition=function(element){var top=0;var left=0;do{top+=element.offsetTop||0;left+=element.offsetLeft||0;element=element.offsetParent}while(element);return{top:top,left:left}};
window.addEventListener("DOMContentLoaded",function(){width=window.innerWidth;height=window.innerHeight;clock=new THREE.Clock;scene=new Physijs.Scene;scene.setGravity(new THREE.Vector3(0,-9.81,0));renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(width,height);renderer.shadowMapEnabled=true;renderer.shadowMapSoft=true;document.body.appendChild(renderer.domElement);camera=new THREE.PerspectiveCamera(40,width/height,1,1E3);scene.add(camera);loadSkyAndGround();createCubes();loadPlayerMesh();
animate();document.addEventListener("keydown",keydownControls);document.addEventListener("keyup",keyupControls);document.addEventListener("mousemove",mousemoveControls)},false);var keyboard={escape:27,space:32,left:37,up:38,right:39,down:40,c:67,d:68,e:69,f:70,q:81,s:83,z:90};var isCameraFirstPerson=false;var firstPersonCameraDistance=0.5;var thirdPersonCameraDistance=5;var mouse={x:0,y:0};var pointer={x:0,y:0};var oldPointer={x:0,y:0};
function mousemoveControls(e){mouse={x:e.clientX-getElementPosition(renderer.domElement).left,y:e.clientY-getElementPosition(renderer.domElement).top};pointer.x=mouse.x/renderer.domElement.width*2-1;pointer.y=-(mouse.y/renderer.domElement.height)*2+1;player.camera.x+=(oldPointer.x-pointer.x)*player.camera.speed;player.camera.y+=(oldPointer.y-pointer.y)*player.camera.speed;if(player.camera.y>160)player.camera.y=160;else if(player.camera.y<-15)player.camera.y=-15;moveState.angle=player.camera.x/2%360;
oldPointer={x:pointer.x,y:pointer.y}}
function keydownControls(e){if(e.keyCode===keyboard.space)if(player.model.state==="stand"){changeMotion("jump");player.position.y+=player.modelHeight/2}if(e.keyCode===keyboard.f){isCameraFirstPerson=!isCameraFirstPerson;player.camera.distance=isCameraFirstPerson?firstPersonCameraDistance:thirdPersonCameraDistance}if(e.keyCode===keyboard.c)if(player.model.state==="stand")changeMotion("crstand");else{if(player.model.state==="crstand")changeMotion("stand")}else if(e.keyCode===keyboard.z||e.keyCode===
keyboard.up){moveState.front=true;moveState.Backwards=false}else if(e.keyCode===keyboard.s||e.keyCode===keyboard.down){moveState.Backwards=true;moveState.front=false}else if(e.keyCode===keyboard.q||e.keyCode===keyboard.left){moveState.left=true;moveState.right=false}else if(e.keyCode===keyboard.d||e.keyCode===keyboard.right){moveState.right=true;moveState.left=false}else return;if(!moveState.moving){if(player.model.state==="stand")changeMotion("run");if(player.model.state==="crstand")changeMotion("crwalk");
moveState.moving=true;move();timer=setInterval(function(){move()},1E3/60)}}
function keyupControls(e){if(e.keyCode===keyboard.z||e.keyCode===keyboard.up)moveState.front=false;else if(e.keyCode===keyboard.s||e.keyCode===keyboard.down)moveState.Backwards=false;else if(e.keyCode===keyboard.q||e.keyCode===keyboard.left)moveState.left=false;else if(e.keyCode===keyboard.d||e.keyCode===keyboard.right)moveState.right=false;if(!moveState.front&&!moveState.Backwards&&!moveState.left&&!moveState.right){changeMotion(player.model.state);moveState.moving=false;clearInterval(timer)}};
