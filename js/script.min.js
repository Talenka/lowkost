'use strict';var Physijs=function(){parseInt(THREE.REVISION,10);var c,g=new THREE.Matrix4,k=!1,p=b,b={},l,q,t,n,u,v,w,m=new THREE.Vector3,x=new THREE.Vector3,r=new THREE.Matrix4,s=new THREE.Quaternion;b.scripts={};l=function(){this._eventListeners={}};l.prototype.addEventListener=function(a,d){this._eventListeners.hasOwnProperty(a)||(this._eventListeners[a]=[]);this._eventListeners[a].push(d)};l.prototype.removeEventListener=function(a,d){var h;return this._eventListeners.hasOwnProperty(a)?0<=(h=
this._eventListeners[a].indexOf(d))?(this._eventListeners[a].splice(h,1),!0):!1:!1};l.prototype.dispatchEvent=function(a){var d,h=Array.prototype.splice.call(arguments,1);if(this._eventListeners.hasOwnProperty(a))for(d=0;d<this._eventListeners[a].length;d++)this._eventListeners[a][d].apply(this,h)};l.make=function(a){a.prototype.addEventListener=l.prototype.addEventListener;a.prototype.removeEventListener=l.prototype.removeEventListener;a.prototype.dispatchEvent=l.prototype.dispatchEvent};q=function(){var a=
1;return function(){return a++}}();t=function(a,d,h,e){return new THREE.Vector3(Math.atan2(2*(a*e-d*h),e*e-a*a-d*d+h*h),Math.asin(2*(a*h+d*e)),Math.atan2(2*(h*e-a*d),e*e+a*a-d*d-h*h))};n=function(a,d){r.identity();d.useQuaternion?r.identity().setRotationFromQuaternion(d.quaternion):r.identity().setRotationFromEuler(d.rotation);r.getInverse(r);m.copy(a);x.copy(d.position);return m.sub(x).applyMatrix4(r)};b.noConflict=function(){window.Physijs=p;return b};b.createMaterial=function(a,d,h){var e=function(){};
e.prototype=a;e=new e;e._physijs={id:a.id,friction:void 0===d?0.8:d,restitution:void 0===h?0.2:h};return e};b.PointConstraint=function(a,d,h){void 0===h&&(h=d,d=void 0);this.type="point";this.appliedImpulse=0;this.id=q();this.objecta=a._physijs.id;this.positiona=n(h,a).clone();d&&(this.objectb=d._physijs.id,this.positionb=n(h,d).clone())};b.PointConstraint.prototype.getDefinition=function(){return{type:this.type,id:this.id,objecta:this.objecta,objectb:this.objectb,positiona:this.positiona,positionb:this.positionb}};
b.HingeConstraint=function(a,d,h,e){void 0===e&&(e=h,h=d,d=void 0);this.type="hinge";this.appliedImpulse=0;this.id=q();this.scene=a.parent;this.objecta=a._physijs.id;this.positiona=n(h,a).clone();this.position=h.clone();this.axis=e;d&&(this.objectb=d._physijs.id,this.positionb=n(h,d).clone())};b.HingeConstraint.prototype.getDefinition=function(){return{type:this.type,id:this.id,objecta:this.objecta,objectb:this.objectb,positiona:this.positiona,positionb:this.positionb,axis:this.axis}};b.HingeConstraint.prototype.setLimits=
function(a,d,h,e){this.scene.execute("hinge_setLimits",{constraint:this.id,low:a,high:d,bias_factor:h,relaxation_factor:e})};b.HingeConstraint.prototype.enableAngularMotor=function(a,d){this.scene.execute("hinge_enableAngularMotor",{constraint:this.id,velocity:a,acceleration:d})};b.HingeConstraint.prototype.disableMotor=function(a,d){this.scene.execute("hinge_disableMotor",{constraint:this.id})};b.SliderConstraint=function(a,d,h,e){void 0===e&&(e=h,h=d,d=void 0);this.type="slider";this.appliedImpulse=
0;this.id=q();this.scene=a.parent;this.objecta=a._physijs.id;this.positiona=n(h,a).clone();this.axis=e;d&&(this.objectb=d._physijs.id,this.positionb=n(h,d).clone())};b.SliderConstraint.prototype.getDefinition=function(){return{type:this.type,id:this.id,objecta:this.objecta,objectb:this.objectb,positiona:this.positiona,positionb:this.positionb,axis:this.axis}};b.SliderConstraint.prototype.setLimits=function(a,d,h,e){this.scene.execute("slider_setLimits",{constraint:this.id,lin_lower:a,lin_upper:d,
ang_lower:h,ang_upper:e})};b.SliderConstraint.prototype.setRestitution=function(a,d){this.scene.execute("slider_setRestitution",{constraint:this.id,linear:a,angular:d})};b.SliderConstraint.prototype.enableLinearMotor=function(a,d){this.scene.execute("slider_enableLinearMotor",{constraint:this.id,velocity:a,acceleration:d})};b.SliderConstraint.prototype.disableLinearMotor=function(){this.scene.execute("slider_disableLinearMotor",{constraint:this.id})};b.SliderConstraint.prototype.enableAngularMotor=
function(a,d){this.scene.execute("slider_enableAngularMotor",{constraint:this.id,velocity:a,acceleration:d})};b.SliderConstraint.prototype.disableAngularMotor=function(){this.scene.execute("slider_disableAngularMotor",{constraint:this.id})};b.ConeTwistConstraint=function(a,d,h){if(void 0===h)throw"Both objects must be defined in a ConeTwistConstraint.";this.type="conetwist";this.appliedImpulse=0;this.id=q();this.scene=a.parent;this.objecta=a._physijs.id;this.positiona=n(h,a).clone();this.objectb=
d._physijs.id;this.positionb=n(h,d).clone();this.axisa={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};this.axisb={x:d.rotation.x,y:d.rotation.y,z:d.rotation.z}};b.ConeTwistConstraint.prototype.getDefinition=function(){return{type:this.type,id:this.id,objecta:this.objecta,objectb:this.objectb,positiona:this.positiona,positionb:this.positionb,axisa:this.axisa,axisb:this.axisb}};b.ConeTwistConstraint.prototype.setLimit=function(a,d,h){this.scene.execute("conetwist_setLimit",{constraint:this.id,x:a,y:d,
z:h})};b.ConeTwistConstraint.prototype.enableMotor=function(){this.scene.execute("conetwist_enableMotor",{constraint:this.id})};b.ConeTwistConstraint.prototype.setMaxMotorImpulse=function(a){this.scene.execute("conetwist_setMaxMotorImpulse",{constraint:this.id,max_impulse:a})};b.ConeTwistConstraint.prototype.setMotorTarget=function(a){if(a instanceof THREE.Vector3)throw"Wait for Three.js r50 to setMotorTarget from Vector3 - use Matrix4 or Quaternion instead";a instanceof THREE.Matrix4&&(a=(new THREE.Quaternion).setFromRotationMatrix(a));
this.scene.execute("conetwist_setMotorTarget",{constraint:this.id,x:a.x,y:a.y,z:a.z,w:a.w})};b.ConeTwistConstraint.prototype.disableMotor=function(){this.scene.execute("conetwist_disableMotor",{constraint:this.id})};b.DOFConstraint=function(a,d,h){void 0===h&&(h=d,d=void 0);this.type="dof";this.appliedImpulse=0;this.id=q();this.scene=a.parent;this.objecta=a._physijs.id;this.positiona=n(h,a).clone();this.axisa={x:a.rotation.x,y:a.rotation.y,z:a.rotation.z};d&&(this.objectb=d._physijs.id,this.positionb=
n(h,d).clone(),this.axisb={x:d.rotation.x,y:d.rotation.y,z:d.rotation.z})};b.DOFConstraint.prototype.getDefinition=function(){return{type:this.type,id:this.id,objecta:this.objecta,objectb:this.objectb,positiona:this.positiona,positionb:this.positionb,axisa:this.axisa,axisb:this.axisb}};b.DOFConstraint.prototype.setLinearLowerLimit=function(a){this.scene.execute("dof_setLinearLowerLimit",{constraint:this.id,x:a.x,y:a.y,z:a.z})};b.DOFConstraint.prototype.setLinearUpperLimit=function(a){this.scene.execute("dof_setLinearUpperLimit",
{constraint:this.id,x:a.x,y:a.y,z:a.z})};b.DOFConstraint.prototype.setAngularLowerLimit=function(a){this.scene.execute("dof_setAngularLowerLimit",{constraint:this.id,x:a.x,y:a.y,z:a.z})};b.DOFConstraint.prototype.setAngularUpperLimit=function(a){this.scene.execute("dof_setAngularUpperLimit",{constraint:this.id,x:a.x,y:a.y,z:a.z})};b.DOFConstraint.prototype.enableAngularMotor=function(a){this.scene.execute("dof_enableAngularMotor",{constraint:this.id,which:a})};b.DOFConstraint.prototype.configureAngularMotor=
function(a,d,h,e,b){this.scene.execute("dof_configureAngularMotor",{constraint:this.id,which:a,low_angle:d,high_angle:h,velocity:e,max_force:b})};b.DOFConstraint.prototype.disableAngularMotor=function(a){this.scene.execute("dof_disableAngularMotor",{constraint:this.id,which:a})};b.Scene=function(a){var d=this;l.call(this);THREE.Scene.call(this);this._worker=new Worker(b.scripts.worker||"physijs_worker.js");this._worker.transferableMessage=this._worker.webkitPostMessage||this._worker.postMessage;this._materials=
{};this._objects={};this._vehicles={};this._constraints={};var h=new ArrayBuffer(1);this._worker.transferableMessage(h,[h]);c=0===h.byteLength;this._worker.onmessage=function(a){a=a.data;a instanceof ArrayBuffer&&1!==a.byteLength&&(a=new Float32Array(a));if(a instanceof Float32Array)switch(a[0]){case 0:d._updateScene(a);break;case 1:d._updateCollisions(a);break;case 2:d._updateVehicles(a);break;case 3:d._updateConstraints(a)}else if(a.cmd)switch(a.cmd){case "objectReady":a=a.params;d._objects[a]&&
d._objects[a].dispatchEvent("ready");break;case "worldReady":d.dispatchEvent("ready");break;case "vehicle":window.test=a;break;default:window.console.debug("Received: "+a.cmd),window.console.dir(a.params)}else switch(a[0]){case 0:d._updateScene(a);break;case 1:d._updateCollisions(a);break;case 2:d._updateVehicles(a);break;case 3:d._updateConstraints(a)}};a=a||{};a.ammo=b.scripts.ammo||"ammo.js";a.fixedTimeStep=a.fixedTimeStep||1/60;a.rateLimit=a.rateLimit||!0;this.execute("init",a)};b.Scene.prototype=
new THREE.Scene;b.Scene.prototype.constructor=b.Scene;l.make(b.Scene);b.Scene.prototype._updateScene=function(a){var d=a[1],h,b,f;for(b=0;b<d;b++)f=2+14*b,h=this._objects[a[f]],void 0!==h&&(!1===h.__dirtyPosition&&h.position.set(a[f+1],a[f+2],a[f+3]),!1===h.__dirtyRotation&&(h.useQuaternion?h.quaternion.set(a[f+4],a[f+5],a[f+6],a[f+7]):h.rotation=t(a[f+4],a[f+5],a[f+6],a[f+7])),h._physijs.linearVelocity.set(a[f+8],a[f+9],a[f+10]),h._physijs.angularVelocity.set(a[f+11],a[f+12],a[f+13]));c&&this._worker.transferableMessage(a.buffer,
[a.buffer]);k=!1;this.dispatchEvent("update")};b.Scene.prototype._updateVehicles=function(a){var d,h,b;for(h=0;h<(a.length-1)/9;h++)b=1+9*h,d=this._vehicles[a[b]],void 0!==d&&(d=d.wheels[a[b+1]],d.position.set(a[b+2],a[b+3],a[b+4]),d.useQuaternion?d.quaternion.set(a[b+5],a[b+6],a[b+7],a[b+8]):d.rotation=t(a[b+5],a[b+6],a[b+7],a[b+8]));c&&this._worker.transferableMessage(a.buffer,[a.buffer])};b.Scene.prototype._updateConstraints=function(a){var d,h,b,f;for(b=0;b<(a.length-1)/6;b++)f=1+6*b,d=this._constraints[a[f]],
h=this._objects[a[f+1]],void 0!==d&&void 0!==h&&(m.set(a[f+2],a[f+3],a[f+4]),r.extractRotation(h.matrix),m.applyMatrix4(r),d.positiona.addVectors(h.position,m),d.appliedImpulse=a[f+5]);c&&this._worker.transferableMessage(a.buffer,[a.buffer])};b.Scene.prototype._updateCollisions=function(a){var d,b,e,f={},g=[];for(d=0;d<a[1];d++)b=2+2*d,e=a[b],b=a[b+1],f[e]||(f[e]=[]),f[e].push(b);for(e in this._objects){if(!this._objects.hasOwnProperty(e))return;e=this._objects[e];if(f[e._physijs.id]){for(d=g.length=
0;d<f[e._physijs.id].length;d++)if(b=this._objects[f[e._physijs.id][d]])-1===e._physijs.touches.indexOf(b._physijs.id)&&(e._physijs.touches.push(b._physijs.id),m.subVectors(e.getLinearVelocity(),b.getLinearVelocity()),v=m.clone(),m.subVectors(e.getAngularVelocity(),b.getAngularVelocity()),w=m,e.dispatchEvent("collision",b,v,w),b.dispatchEvent("collision",e,v,w)),g.push(b._physijs.id);for(d=0;d<e._physijs.touches.length;d++)-1===g.indexOf(e._physijs.touches[d])&&e._physijs.touches.splice(d--,1)}else e._physijs.touches.length=
0}for(var k in f)if(f.hasOwnProperty(k)&&f[k])for(d=0;d<f[k].length;d++)f[k][d]&&(f[f[k][d]]=f[f[k][d]]||[],f[f[k][d]].push(k));this.collisions=f;c&&this._worker.transferableMessage(a.buffer,[a.buffer])};b.Scene.prototype.addConstraint=function(a,d){this._constraints[a.id]=a;this.execute("addConstraint",a.getDefinition());if(d){var b;switch(a.type){case "point":b=new THREE.Mesh(new THREE.SphereGeometry(1.5),new THREE.MeshNormalMaterial);b.position.copy(a.positiona);this._objects[a.objecta].add(b);
break;case "hinge":b=new THREE.Mesh(new THREE.SphereGeometry(1.5),new THREE.MeshNormalMaterial);b.position.copy(a.positiona);this._objects[a.objecta].add(b);break;case "slider":b=new THREE.Mesh(new THREE.CubeGeometry(10,1,1),new THREE.MeshNormalMaterial);b.position.copy(a.positiona);b.rotation.set(a.axis.y,a.axis.x,a.axis.z);this._objects[a.objecta].add(b);break;case "conetwist":b=new THREE.Mesh(new THREE.SphereGeometry(1.5),new THREE.MeshNormalMaterial);b.position.copy(a.positiona);this._objects[a.objecta].add(b);
break;case "dof":b=new THREE.Mesh(new THREE.SphereGeometry(1.5),new THREE.MeshNormalMaterial),b.position.copy(a.positiona),this._objects[a.objecta].add(b)}}return a};b.Scene.prototype.removeConstraint=function(a){void 0!==this._constraints[a.id]&&(this.execute("removeConstraint",{id:a.id}),delete this._constraints[a.id])};b.Scene.prototype.execute=function(a,d){this._worker.postMessage({cmd:a,params:d})};u=function(a,d){var b;for(b=0;b<d.children.length;b++)d.children[b]._physijs&&(d.children[b].updateMatrix(),
d.children[b].updateMatrixWorld(),m.getPositionFromMatrix(d.children[b].matrixWorld),s.setFromRotationMatrix(d.children[b].matrixWorld),d.children[b]._physijs.position_offset={x:m.x,y:m.y,z:m.z},d.children[b]._physijs.rotation={x:s.x,y:s.y,z:s.z,w:s.w},a._physijs.children.push(d.children[b]._physijs)),u(a,d.children[b])};b.Scene.prototype.add=function(a){THREE.Mesh.prototype.add.call(this,a);a._physijs&&(a.world=this,a instanceof b.Vehicle?(this.add(a.mesh),this._vehicles[a._physijs.id]=a,this.execute("addVehicle",
a._physijs)):(a.__dirtyPosition=!1,a.__dirtyRotation=!1,this._objects[a._physijs.id]=a,a.children.length&&(a._physijs.children=[],u(a,a)),a.material._physijs&&!this._materials.hasOwnProperty(a.material._physijs.id)&&(this.execute("registerMaterial",a.material._physijs),a._physijs.materialId=a.material._physijs.id),a._physijs.position={x:a.position.x,y:a.position.y,z:a.position.z},a.useQuaternion||(g.identity().setRotationFromEuler(a.rotation),a.quaternion.setFromRotationMatrix(g)),a._physijs.rotation=
{x:a.quaternion.x,y:a.quaternion.y,z:a.quaternion.z,w:a.quaternion.w},new THREE.Vector3(1,1,1),a._physijs.width&&(a._physijs.width*=a.scale.x),a._physijs.height&&(a._physijs.height*=a.scale.y),a._physijs.depth&&(a._physijs.depth*=a.scale.z),this.execute("addObject",a._physijs)))};b.Scene.prototype.remove=function(a){if(a instanceof b.Vehicle){for(this.execute("removeVehicle",{id:a._physijs.id});a.wheels.length;)this.remove(a.wheels.pop());this.remove(a.mesh);delete this._vehicles[a._physijs.id]}else THREE.Mesh.prototype.remove.call(this,
a),a._physijs&&(delete this._objects[a._physijs.id],this.execute("removeObject",{id:a._physijs.id}))};b.Scene.prototype.setFixedTimeStep=function(a){a&&this.execute("setFixedTimeStep",a)};b.Scene.prototype.setGravity=function(a){a&&this.execute("setGravity",a)};b.Scene.prototype.simulate=function(a,d){var b,c,f;if(k)return!1;k=!0;for(b in this._objects)this._objects.hasOwnProperty(b)&&(c=this._objects[b],c.__dirtyPosition||c.__dirtyRotation)&&(f={id:c._physijs.id},c.__dirtyPosition&&(f.pos={x:c.position.x,
y:c.position.y,z:c.position.z},c.__dirtyPosition=!1),c.__dirtyRotation&&(c.useQuaternion||(g.identity().setRotationFromEuler(c.rotation),c.quaternion.setFromRotationMatrix(g)),f.quat={x:c.quaternion.x,y:c.quaternion.y,z:c.quaternion.z,w:c.quaternion.w},c.__dirtyRotation=!1),this.execute("updateTransform",f));this.execute("simulate",{timeStep:a,maxSubSteps:d});return!0};b.Mesh=function(a,b,c){a&&(l.call(this),THREE.Mesh.call(this,a,b),a.boundingBox||a.computeBoundingBox(),this._physijs={type:null,
id:q(),mass:c||0,touches:[],linearVelocity:new THREE.Vector3,angularVelocity:new THREE.Vector3})};b.Mesh.prototype=new THREE.Mesh;b.Mesh.prototype.constructor=b.Mesh;l.make(b.Mesh);b.Mesh.prototype.__defineGetter__("mass",function(){return this._physijs.mass});b.Mesh.prototype.__defineSetter__("mass",function(a){this._physijs.mass=a;this.world&&this.world.execute("updateMass",{id:this._physijs.id,mass:a})});b.Mesh.prototype.applyCentralImpulse=function(a){this.world&&this.world.execute("applyCentralImpulse",
{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.applyImpulse=function(a,b){this.world&&this.world.execute("applyImpulse",{id:this._physijs.id,impulse_x:a.x,impulse_y:a.y,impulse_z:a.z,x:b.x,y:b.y,z:b.z})};b.Mesh.prototype.applyCentralForce=function(a){this.world&&this.world.execute("applyCentralForce",{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.applyForce=function(a,b){this.world&&this.world.execute("applyForce",{id:this._physijs.id,force_x:a.x,force_y:a.y,force_z:a.z,x:b.x,
y:b.y,z:b.z})};b.Mesh.prototype.getAngularVelocity=function(){return this._physijs.angularVelocity};b.Mesh.prototype.setAngularVelocity=function(a){this.world&&this.world.execute("setAngularVelocity",{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.getLinearVelocity=function(){return this._physijs.linearVelocity};b.Mesh.prototype.setLinearVelocity=function(a){this.world&&this.world.execute("setLinearVelocity",{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.setAngularFactor=function(a){this.world&&
this.world.execute("setAngularFactor",{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.setLinearFactor=function(a){this.world&&this.world.execute("setLinearFactor",{id:this._physijs.id,x:a.x,y:a.y,z:a.z})};b.Mesh.prototype.setDamping=function(a,b){this.world&&this.world.execute("setDamping",{id:this._physijs.id,linear:a,angular:b})};b.Mesh.prototype.setCcdMotionThreshold=function(a){this.world&&this.world.execute("setCcdMotionThreshold",{id:this._physijs.id,threshold:a})};b.Mesh.prototype.setCcdSweptSphereRadius=
function(a){this.world&&this.world.execute("setCcdSweptSphereRadius",{id:this._physijs.id,radius:a})};b.PlaneMesh=function(a,d,c){var e;b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;this._physijs.type="plane";this._physijs.normal=a.faces[0].normal.clone();this._physijs.mass="undefined"===typeof c?d*e:c};b.PlaneMesh.prototype=new b.Mesh;b.PlaneMesh.prototype.constructor=b.PlaneMesh;b.HeightfieldMesh=
function(a,d,c,e,f){b.Mesh.call(this,a,d,c);this._physijs.type="heightfield";this._physijs.xsize=a.boundingBox.max.x-a.boundingBox.min.x;this._physijs.ysize=a.boundingBox.max.y-a.boundingBox.min.y;this._physijs.xpts="undefined"===typeof e?Math.sqrt(a.vertices.length):e+1;this._physijs.ypts="undefined"===typeof f?Math.sqrt(a.vertices.length):f+1;this._physijs.absMaxHeight=Math.max(a.boundingBox.max.z,Math.abs(a.boundingBox.min.z));d=[];for(f=0;f<a.vertices.length;f++)c=f%this._physijs.xpts,e=Math.round(f/
this._physijs.xpts-f%this._physijs.xpts/this._physijs.xpts),d[f]=a.vertices[c+(this._physijs.ypts-e-1)*this._physijs.ypts].z;this._physijs.points=d};b.HeightfieldMesh.prototype=new b.Mesh;b.HeightfieldMesh.prototype.constructor=b.HeightfieldMesh;b.BoxMesh=function(a,d,c){var e;b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;a=a.boundingBox.max.z-a.boundingBox.min.z;this._physijs.type="box";this._physijs.width=
d;this._physijs.height=e;this._physijs.depth=a;this._physijs.mass="undefined"===typeof c?d*e*a:c};b.BoxMesh.prototype=new b.Mesh;b.BoxMesh.prototype.constructor=b.BoxMesh;b.SphereMesh=function(a,d,c){b.Mesh.call(this,a,d,c);a.boundingSphere||a.computeBoundingSphere();this._physijs.type="sphere";this._physijs.radius=a.boundingSphere.radius;this._physijs.mass="undefined"===typeof c?4/3*Math.PI*Math.pow(this._physijs.radius,3):c};b.SphereMesh.prototype=new b.Mesh;b.SphereMesh.prototype.constructor=b.SphereMesh;
b.CylinderMesh=function(a,d,c){var e;b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;a=a.boundingBox.max.z-a.boundingBox.min.z;this._physijs.type="cylinder";this._physijs.width=d;this._physijs.height=e;this._physijs.depth=a;this._physijs.mass="undefined"===typeof c?d*e*a:c};b.CylinderMesh.prototype=new b.Mesh;b.CylinderMesh.prototype.constructor=b.CylinderMesh;b.CapsuleMesh=function(a,d,c){var e;b.Mesh.call(this,
a,d,c);a.boundingBox||a.computeBoundingBox();d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;a=a.boundingBox.max.z-a.boundingBox.min.z;this._physijs.type="capsule";this._physijs.radius=Math.max(d/2,a/2);this._physijs.height=e;this._physijs.mass="undefined"===typeof c?d*e*a:c};b.CapsuleMesh.prototype=new b.Mesh;b.CapsuleMesh.prototype.constructor=b.CapsuleMesh;b.ConeMesh=function(a,d,c){b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();d=a.boundingBox.max.x-
a.boundingBox.min.x;a=a.boundingBox.max.y-a.boundingBox.min.y;this._physijs.type="cone";this._physijs.radius=d/2;this._physijs.height=a;this._physijs.mass="undefined"===typeof c?d*a:c};b.ConeMesh.prototype=new b.Mesh;b.ConeMesh.prototype.constructor=b.ConeMesh;b.ConcaveMesh=function(a,d,c){var e,f,g=[];b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();e=a.vertices;for(d=0;d<a.faces.length;d++)f=a.faces[d],f instanceof THREE.Face3?g.push([{x:e[f.a].x,y:e[f.a].y,z:e[f.a].z},{x:e[f.b].x,
y:e[f.b].y,z:e[f.b].z},{x:e[f.c].x,y:e[f.c].y,z:e[f.c].z}]):f instanceof THREE.Face4&&(g.push([{x:e[f.a].x,y:e[f.a].y,z:e[f.a].z},{x:e[f.b].x,y:e[f.b].y,z:e[f.b].z},{x:e[f.d].x,y:e[f.d].y,z:e[f.d].z}]),g.push([{x:e[f.b].x,y:e[f.b].y,z:e[f.b].z},{x:e[f.c].x,y:e[f.c].y,z:e[f.c].z},{x:e[f.d].x,y:e[f.d].y,z:e[f.d].z}]));d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;a=a.boundingBox.max.z-a.boundingBox.min.z;this._physijs.type="concave";this._physijs.triangles=g;this._physijs.mass=
"undefined"===typeof c?d*e*a:c};b.ConcaveMesh.prototype=new b.Mesh;b.ConcaveMesh.prototype.constructor=b.ConcaveMesh;b.ConvexMesh=function(a,d,c){var e,f=[];b.Mesh.call(this,a,d,c);a.boundingBox||a.computeBoundingBox();for(d=0;d<a.vertices.length;d++)f.push({x:a.vertices[d].x,y:a.vertices[d].y,z:a.vertices[d].z});d=a.boundingBox.max.x-a.boundingBox.min.x;e=a.boundingBox.max.y-a.boundingBox.min.y;a=a.boundingBox.max.z-a.boundingBox.min.z;this._physijs.type="convex";this._physijs.points=f;this._physijs.mass=
"undefined"===typeof c?d*e*a:c};b.ConvexMesh.prototype=new b.Mesh;b.ConvexMesh.prototype.constructor=b.ConvexMesh;b.Vehicle=function(a,d){d=d||new b.VehicleTuning;this.mesh=a;this.wheels=[];this._physijs={id:q(),rigidBody:a._physijs.id,suspension_stiffness:d.suspension_stiffness,suspension_compression:d.suspension_compression,suspension_damping:d.suspension_damping,max_suspension_travel:d.max_suspension_travel,friction_slip:d.friction_slip,max_suspension_force:d.max_suspension_force}};b.Vehicle.prototype.addWheel=
function(a,b,c,e,f,g,k,l,m){a=new THREE.Mesh(a,b);a.castShadow=a.receiveShadow=!0;a.position.copy(e).multiplyScalar(g/100).add(c);this.world.add(a);this.wheels.push(a);this.world.execute("addWheel",{id:this._physijs.id,connection_point:{x:c.x,y:c.y,z:c.z},wheel_direction:{x:e.x,y:e.y,z:e.z},wheel_axle:{x:f.x,y:f.y,z:f.z},suspension_rest_length:g,wheel_radius:k,is_front_wheel:l,tuning:m})};b.Vehicle.prototype.setSteering=function(a,b){if(void 0!==b&&void 0!==this.wheels[b])this.world.execute("setSteering",
{id:this._physijs.id,wheel:b,steering:a});else if(0<this.wheels.length)for(var c=0;c<this.wheels.length;c++)this.world.execute("setSteering",{id:this._physijs.id,wheel:c,steering:a})};b.Vehicle.prototype.setBrake=function(a,b){if(void 0!==b&&void 0!==this.wheels[b])this.world.execute("setBrake",{id:this._physijs.id,wheel:b,brake:a});else if(0<this.wheels.length)for(var c=0;c<this.wheels.length;c++)this.world.execute("setBrake",{id:this._physijs.id,wheel:c,brake:a})};b.Vehicle.prototype.applyEngineForce=
function(a,b){if(void 0!==b&&void 0!==this.wheels[b])this.world.execute("applyEngineForce",{id:this._physijs.id,wheel:b,force:a});else if(0<this.wheels.length)for(var c=0;c<this.wheels.length;c++)this.world.execute("applyEngineForce",{id:this._physijs.id,wheel:c,force:a})};b.VehicleTuning=function(a,b,c,e,f,g){this.suspension_stiffness=void 0!==a?a:5.88;this.suspension_compression=void 0!==b?b:0.83;this.suspension_damping=void 0!==c?c:0.88;this.max_suspension_travel=void 0!==e?e:500;this.friction_slip=
void 0!==f?f:10.5;this.max_suspension_force=void 0!==g?g:6E3};return b}();var keyboard={escape:27,space:32,left:37,up:38,right:39,down:40,c:67,d:68,e:69,f:70,q:81,s:83,z:90},isCameraFirstPerson=!1,firstPersonCameraDistance=0.5,thirdPersonCameraDistance=5,mouse={x:0,y:0},pointer={x:0,y:0},oldPointer={x:0,y:0};
function mousemoveControls(c){mouse={x:c.clientX-getElementPosition(renderer.domElement).left,y:c.clientY-getElementPosition(renderer.domElement).top};pointer.x=2*(mouse.x/renderer.domElement.width)-1;pointer.y=2*-(mouse.y/renderer.domElement.height)+1;player.camera.x+=(oldPointer.x-pointer.x)*player.camera.speed;player.camera.y+=(oldPointer.y-pointer.y)*player.camera.speed;160<player.camera.y?player.camera.y=160:-15>player.camera.y&&(player.camera.y=-15);moveState.angle=player.camera.x/2%360;oldPointer=
{x:pointer.x,y:pointer.y}}
function keydownControls(c){c.keyCode===keyboard.space&&"stand"===player.model.state&&(changeMotion("jump"),player.position.y+=player.modelHeight/2);c.keyCode===keyboard.f&&(isCameraFirstPerson=!isCameraFirstPerson,player.camera.distance=isCameraFirstPerson?firstPersonCameraDistance:thirdPersonCameraDistance);if(c.keyCode===keyboard.c)"stand"===player.model.state?changeMotion("crstand"):"crstand"===player.model.state&&changeMotion("stand");else if(c.keyCode===keyboard.z||c.keyCode===keyboard.up)moveState.front=
!0,moveState.Backwards=!1;else if(c.keyCode===keyboard.s||c.keyCode===keyboard.down)moveState.Backwards=!0,moveState.front=!1;else if(c.keyCode===keyboard.q||c.keyCode===keyboard.left)moveState.left=!0,moveState.right=!1;else if(c.keyCode===keyboard.d||c.keyCode===keyboard.right)moveState.right=!0,moveState.left=!1;else return;moveState.moving||("stand"===player.model.state&&changeMotion("run"),"crstand"===player.model.state&&changeMotion("crwalk"),moveState.moving=!0,move(),timer=setInterval(function(){move()},
1E3/60))}function keyupControls(c){if(c.keyCode===keyboard.z||c.keyCode===keyboard.up)moveState.front=!1;else if(c.keyCode===keyboard.s||c.keyCode===keyboard.down)moveState.Backwards=!1;else if(c.keyCode===keyboard.q||c.keyCode===keyboard.left)moveState.left=!1;else if(c.keyCode===keyboard.d||c.keyCode===keyboard.right)moveState.right=!1;moveState.front||(moveState.Backwards||moveState.left||moveState.right)||(changeMotion(player.model.state),moveState.moving=!1,clearInterval(timer))};var player={model:{objects:new THREE.Object3D,motion:"stand",state:"stand"},position:{x:0,y:0,z:0,direction:0},camera:{speed:500,distance:thirdPersonCameraDistance,x:0,y:0,z:0},physicalShape:!1,modelHeight:1.2,modelRadius:0.3},md2meshBody,treeBody,moveState={moving:!1,front:!1,Backwards:!1,left:!1,right:!1,speed:0.1,angle:0},md2frames={stand:[0,39,9,{state:"stand",action:!1}],run:[40,45,10,{state:"stand",action:!1}],attack:[46,53,10,{state:"stand",action:!0}],pain1:[54,57,7,{state:"stand",action:!0}],
pain2:[58,61,7,{state:"stand",action:!0}],pain3:[62,65,7,{state:"stand",action:!0}],jump:[66,71,7,{state:"stand",action:!0}],flip:[72,83,7,{state:"stand",action:!0}],salute:[84,94,7,{state:"stand",action:!0}],taunt:[95,111,10,{state:"stand",action:!0}],wave:[112,122,7,{state:"stand",action:!0}],point:[123,134,6,{state:"stand",action:!0}],crstand:[135,153,10,{state:"crstand",action:!1}],crwalk:[154,159,7,{state:"crstand",action:!1}],crattack:[160,168,10,{state:"crstand",action:!0}],crpain:[196,172,
7,{state:"crstand",action:!0}],crdeath:[173,177,5,{state:"freeze",action:!0}],death1:[178,183,7,{state:"freeze",action:!0}],death2:[184,189,7,{state:"freeze",action:!0}],death3:[190,197,7,{state:"freeze",action:!0}],boom:[198,198,5]},direction=0;
function move(){"run"!==player.model.motion&&"stand"===player.model.state?changeMotion("run"):"crwalk"!==player.model.motion&&"crstand"===player.model.state&&changeMotion("crwalk");var c=moveState.speed;"crstand"===player.model.state?c*=0.5:"freeze"===player.model.state&&(c=0);direction=moveState.angle;direction=moveState.front?moveState.left?45:moveState.right?315:0:moveState.Backwards?moveState.left?135:moveState.right?225:180:moveState.left?90:moveState.right?270:0;direction+=player.camera.x/2;
player.model.objects.rotation.y=direction*deg2rad;player.position.x-=Math.sin(direction*deg2rad)*c;player.position.z-=Math.cos(direction*deg2rad)*c}function changeMotion(c){player.model.motion=c;player.model.state=md2frames[c][3].state;var g=md2frames[c][0],k=md2frames[c][1];c=md2frames[c][2];md2meshBody.time=0;md2meshBody.duration=1E3*((k-g)/c);md2meshBody.setFrameRange(g,k)}
function animate(){requestAnimationFrame(animate);player.model.objects.position={x:player.position.x,y:player.position.y,z:player.position.z};player.physicalShape&&(player.physicalShape.position.x=player.position.x,player.physicalShape.position.y=player.position.y+player.modelHeight/2,player.physicalShape.position.z=player.position.z);camera.position.x=player.position.x+player.camera.distance*Math.sin(player.camera.x*deg2rad/2);camera.position.z=player.position.z+player.camera.distance*Math.cos(player.camera.x*
deg2rad/2);camera.position.y=1+player.position.y+player.camera.distance*Math.sin(player.camera.y*deg2rad/2);camera.lookAt(new THREE.Vector3(player.position.x,player.position.y+1,player.position.z));var c=clock.getDelta();if(md2meshBody){var g=md2frames[player.model.motion][1]===md2meshBody.currentKeyframe,k=md2frames[player.model.motion][3].action;!k||k&&!g?md2meshBody.updateAnimation(1E3*c):/freeze/.test(md2frames[player.model.motion][3].state)||changeMotion(player.model.state)}renderer.render(scene,
camera);scene.simulate()}function playerCollision(c,g,k){window.console.log(g)}function loadSkyAndGround(){scene.fog=new THREE.FogExp2(10066431,0.01);var c=new THREE.AmbientLight(2105376);scene.add(c);createSimpleObject({shape:"plane",size:[1E3,1E3],m:0,texture:"images/grass.png"});c=new THREE.DirectionalLight(16777210,1.5);c.position.set(1,50,1).normalize();c.castShadow=!0;scene.add(c)}
function createPlayer(c){droidMaterial=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/droid.png"),ambient:10066329,color:16777215,specular:16777215,shininess:25,morphTargets:!0});md2meshBody=new THREE.MorphAnimMesh(c,droidMaterial);md2meshBody.rotation.y=-Math.PI/2;md2meshBody.scale.set(0.02,0.02,0.02);md2meshBody.position.y=0.5;md2meshBody.castShadow=!0;md2meshBody.receiveShadow=!0;changeMotion("stand");player.model.objects.add(md2meshBody);player.physicalShape=new Physijs.BoxMesh(new THREE.CylinderGeometry(player.modelRadius,
player.modelRadius,player.modelHeight,16,4,!1),new THREE.MeshLambertMaterial({opacity:0.3,transparent:!0}),1);player.physicalShape.position.y=player.modelHeight/2;player.physicalShape.addEventListener("collision",playerCollision);scene.add(player.model.objects);scene.add(player.physicalShape)}
function loadPlayerMesh(){droidMaterial=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/1.png"),ambient:10066329,color:16777215,specular:16777215,shininess:25,morphTargets:!0});loader=new THREE.JSONLoader;loader.load("js/droid.js",function(c){md2meshBody=new THREE.MorphAnimMesh(c,droidMaterial);md2meshBody.rotation.y=-Math.PI/2;md2meshBody.scale.set(0.02,0.02,0.02);md2meshBody.position.y=0.5;md2meshBody.castShadow=!0;md2meshBody.receiveShadow=!0;changeMotion("stand");player.model.objects.add(md2meshBody)});
player.physicalShape=new Physijs.BoxMesh(new THREE.CylinderGeometry(player.modelRadius,player.modelRadius,player.modelHeight,16,4,!1),new THREE.MeshLambertMaterial({opacity:0.3,transparent:!0}),1);player.physicalShape.position.y=player.modelHeight/2;player.physicalShape.addEventListener("collision",playerCollision);scene.add(player.model.objects);scene.add(player.physicalShape)}
function createCubes(){for(var c=[],g=0;5>g;g++)c[g]=new Physijs.BoxMesh(new THREE.CubeGeometry(1+Math.random(),Math.random(),1),new THREE.MeshLambertMaterial({color:16777215*Math.random()})),c[g].position.x=5*(g%2)-2.5,c[g].position.y=10*Math.random(),c[g].position.z=-0.8*g,c[g].rotation.x=Math.random(),c[g].rotation.y=Math.random(),c[g].rotation.z=Math.random(),c[g].castShadow=!0,c[g].receiveShadow=!0,scene.add(c[g])}
function createHouse(c,g){var k=new THREE.Mesh(c,new THREE.MeshFaceMaterial(g));k.position.set(-15,0,10);k.scale.set(0.01,0.01,0.01);scene.add(k)}function createBuilding(c,g){var k=new THREE.Mesh(c,new THREE.MeshFaceMaterial(g));k.position.set(-20,0,-5);k.scale.set(0.01,0.01,0.01);scene.add(k)}function createTrees(c){for(var g=[],k=0;5>k;k++)g[k]=new THREE.Mesh(c,new THREE.MeshFaceMaterial),g[k].position.set(2.5,0,3*k+3),g[k].scale.set(0.02,0.02,0.02),scene.add(g[k])}
function createMonster(c){var g=new THREE.MeshLambertMaterial({map:THREE.ImageUtils.loadTexture("images/monster.jpg"),ambient:10066329,color:16777215,specular:16777215,shininess:25,morphTargets:!0});c=new THREE.MorphAnimMesh(c,g);c.position.set(-5,0,0);c.scale.set(0.0010,0.0010,0.0010);scene.add(c)}function isArray(c){return c instanceof Array}function createSimpleObjects(c){for(var g=0,k=c.length;g<k;g++)createSimpleObject(c[g])}
function createSimpleObject(c){var g=isArray(c.pos)?c.pos:[0,0,0],k=isArray(c.rot)?c.rot:[0,0,0];c.color||(c.color=16777215);var p={color:c.color};c.shape||(c.shape="cube");if("cube"==c.shape)var b=isArray(c.size)?c.size:[1,1,1],l=new THREE.CubeGeometry(b[0],b[1],b[2]);else"cylinder"==c.shape?(b=isArray(c.size)?c.size:[0.5,0.5,1],l=new THREE.CylinderGeometry(b[0],b[1],b[2],Math.ceil(8*Math.max(b[0],b[1])),Math.ceil(2*b[2]),!1)):"plane"==c.shape&&(b=isArray(c.size)?c.size:[1,1],l=new THREE.PlaneGeometry(b[0],
b[1]),c.texture&&(p.map=THREE.ImageUtils.loadTexture(c.texture),p.map.repeat.set(b[0],b[1]),p.map.wrapS=p.map.wrapT=THREE.RepeatWrapping));p=Physijs.createMaterial(new THREE.MeshLambertMaterial(p),c.friction,c.spring);c=new Physijs.BoxMesh(l,p,c.m);c.castShadow=!0;c.receiveShadow=!0;c.position.set(g[0],g[1],g[2]);c.rotation.set(k[0],k[1],k[2]);scene.add(c)}
function createRiverSpring(){var c=new Physijs.BoxMesh(new THREE.CylinderGeometry(5,5,0.2,32,2,!0),new THREE.MeshLambertMaterial({color:11141120}));c.position.x=10;c.position.y=0.1;c.position.z=-10;scene.add(c)}
function createTree(){var c=new THREE.MeshLambertMaterial({ambient:10066329,color:65280,specular:16777215,shininess:25,morphTargets:!0});loader=new THREE.JSONLoader;loader.load("js/tree.js",function(g){treeBody=new THREE.Mesh(g,c);treeBody.position.x=4;treeBody.position.y=4;treeBody.position.z=2;treeBody.castShadow=!0;treeBody.receiveShadow=!0});scene.add(treeBody)}
function createRoads(){createRoad({x:0,z:500},{x:0,z:-500});createRoad({x:0,z:-20},{x:100,z:-120});createRoad({x:0,z:-20},{x:-100,z:-120});createRoad({x:0,z:20},{x:100,z:120});createRoad({x:0,z:20},{x:-100,z:120});createRoad({x:500,z:0},{x:-500,z:0});createRoad({x:-20,z:0},{x:-120,z:-100});createRoad({x:-20,z:0},{x:-120,z:100});createRoad({x:20,z:0},{x:120,z:100});createRoad({x:20,z:0},{x:120,z:-100})}
function createRoad(c,g){createSimpleObject({shape:"plane",size:[Math.sqrt((g.x-c.x)*(g.x-c.x)+(g.z-c.z)*(g.z-c.z)),2],pos:[(g.x+c.x)/2,(1+Math.random())/1E3,(g.z+c.z)/2],rot:[0,-Math.atan((g.z-c.z)/(g.x-c.x)),0],m:0,texture:"images/pave.jpg"})}
function loadStuff(){loadSkyAndGround();createCubes();createRoads();createRiverSpring();var c=new THREE.JSONLoader;c.load("js/house.js",createHouse,"images/house");c.load("js/building.js",createBuilding,"images/building");c.load("js/tree.js",createTrees);c.load("js/droid.js",createPlayer);c.load("js/monster.js",createMonster)};Physijs.scripts.worker="js/physijs_worker.js";Physijs.scripts.ammo="ammo.js";var clock,width,height,scene,renderer,deg2rad=Math.PI/180,camera,timer,loader,droidMaterial,getElementPosition=function(c){var g=0,k=0;do g+=c.offsetTop||0,k+=c.offsetLeft||0,c=c.offsetParent;while(c);return{top:g,left:k}};
window.addEventListener("DOMContentLoaded",function(){width=window.innerWidth;height=window.innerHeight;clock=new THREE.Clock;scene=new Physijs.Scene;scene.setGravity(new THREE.Vector3(0,-9.81,0));renderer=new THREE.WebGLRenderer({antialias:!0});renderer.setSize(width,height);renderer.shadowMapEnabled=!0;renderer.shadowMapSoft=!0;document.body.appendChild(renderer.domElement);camera=new THREE.PerspectiveCamera(40,width/height,1,1E3);scene.add(camera);animate();document.addEventListener("keydown",
keydownControls);document.addEventListener("keyup",keyupControls);document.addEventListener("mousemove",mousemoveControls);document.title="Talenka Low Kost";loadStuff()},!1);
